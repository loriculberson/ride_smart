$(document).ready(function(){
// setting up the map, the map options and the starting position

  var mapCanvas = document.getElementById('map-canvas');
  
  var mapOptions = {
    zoom: 13,
    scrollwheel: false,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };

  var initialLocation;
  var denver = new google.maps.LatLng(39.7392, -104.9903)
  var map = new google.maps.Map(mapCanvas, mapOptions);

//W3C Geolocation preferred
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {

      var initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      
      map.setCenter(initialLocation);

      var youMarker = new google.maps.Marker({
      position: initialLocation, 
      map: map, 
  });

    }, function() {
      handleNoGeolocation(true);
    });
  } else {

  //if browser doesn't support Geolocation
    handleNoGeolocation(false);
  }

  function handleNoGeolocation(errorFlag) {
    if (errorFlag) {
      alert("Geolocation service failed");
      initialLocation = denver;
    } else {
      alert("Your browser doesn't support geolocation. We've placed you in Denver.");
      initialLocation = denver;
    }
    map.setCenter(initialLocation);
  }

//populating the map with markers FIRST

fetchMarkers(map);


// click on map and add a pin
  google.maps.event.addListener(map, 'click', function(event){
   alert('Drag marker to site of bike incident');
   var marker = new google.maps.Marker({
     position: event.latLng,
     map: map,
     draggable: true,
     animation: google.maps.Animation.DROP,
     icon: "<%= asset_path('bike_marker2.png') %>"
   });

    var bikeEventData = $($('#form-incident').html())

    var bikeInfoWindow = new google.maps.InfoWindow();

    //set the content of the infoWindow
    bikeInfoWindow.setContent(bikeEventData[0]);    

    google.maps.event.addListener(marker, 'click', function(){
      marker.draggable = false;

      // id for lat and long hidden fields, store marker position
      bikeInfoWindow.open(map, marker);
      $('#bike_event_latitude').val(marker.position.A);
      $('#bike_event_longitude').val(marker.position.F);
    });
     
    //current user can remove their own markers
    var removeMarker = bikeEventData.find('.remove')[0];
    google.maps.event.addDomListener(removeMarker, 'click', function(event) {
      marker.setMap(null);
    });
  });
});
// Create a function that:
// Make an ajax get request to '/bike_events'
function fetchMarkers(map) {
  $.get('/bike_events', function(data) {
    data.forEach(function(bikeEvent){
      var latLng = {lat: +bikeEvent.latitude, lng: +bikeEvent.longitude};
      new google.maps.Marker({
        position: latLng,
        map: map,
        draggable: false,
        animation: google.maps.Animation.DROP,
        icon: "<%= asset_path('bike_marker2.png') %>"
      });
    })
  });
}
// // If 200 (success)


// //   For each marker in the server repsonse
// //     ?? how do we plug a marker into google maps

// // var response; //=> undefined

// // $.get('/lori.com', function(data) { // data = { name: 'wil', email: 'wfaurot@hi.com' }
// //   response = data;
// //   console.log(data);
// // });

// // console.log(response); //=> undefined