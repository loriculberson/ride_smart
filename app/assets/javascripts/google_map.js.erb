$(document).ready(function(){
// setting up the map, the map options and the starting position

  var mapCanvas = $('#map-canvas');
  
  var mapOptions = {
    zoom: 13,
    scrollwheel: false,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };

  var initialLocation;
  var denver = new google.maps.LatLng(39.7392, -104.9903)
  var map = new google.maps.Map(mapCanvas[0], mapOptions);

//W3C Geolocation preferred
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      
      map.setCenter(initialLocation);

      var youMarker = new google.maps.Marker({
      position: initialLocation, 
      map: map, 
    });

    }, function() {
      handleNoGeolocation(true);
    });
  } else {

  //if browser doesn't support Geolocation
    handleNoGeolocation(false);
  }

  function handleNoGeolocation(errorFlag) {
    if (errorFlag) {
      alert("Geolocation service failed");
      initialLocation = denver;
    } else {
      alert("Your browser doesn't support geolocation. We've placed you in Denver.");
      initialLocation = denver;
    }
    map.setCenter(initialLocation);
  }

//populating the map with markers FIRST

  fetchMarkers(map);

if ( window.hasOwnProperty('current_user') ) {
// click on map and add a pin
  google.maps.event.addListener(map, 'click', function loggedInUser(event){
  function bindEvents() {
    var bikeEventForm = $(bikeInfoWindow.getContent());

    //if there are errors in the new bike event form 
    bikeEventForm.on('ajax:error', function(event, xhr, status, error) {
      var errorData = xhr.responseText;
      bikeInfoWindow.setContent(errorData);
      // NOTE: This does not work;
      bindEvents();
    })

    //successful creation of a marker, hit create action, 
    //then get the show view content = responseData


    bikeEventForm.on('ajax:success', function(event, responseData){
      removeLink = $.parseHTML(responseData)[0];
      bikeInfoWindow.close();
      bikeInfoWindow.setContent(responseData);
      bindEvents();
    })
  }

  var marker = new google.maps.Marker({
   position: event.latLng,
   map: map,
   draggable: true,
   animation: google.maps.Animation.DROP,
   icon: "<%= asset_path('bike_marker2.png') %>"
  });

  var initialBikeEventForm = $($('#form-incident').html())

  var bikeInfoWindow = new google.maps.InfoWindow();

  //set the content of the infoWindow
  bikeInfoWindow.setContent(initialBikeEventForm[0]);
 
  bindEvents();

  google.maps.event.addListener(marker, 'click', function(){
    marker.draggable = false;
    // id for lat and long hidden fields, store marker position
    bikeInfoWindow.open(map, marker);
    //console.log($('#bike_event_latitude').val(marker.position.A));
    $('#bike_event_latitude').val(marker.position.A);
    $('#bike_event_longitude').val(marker.position.F);
  });

// $("removeLink").on("ajax:success", 'a.remove-marker', function(e){
//   console.log(e);
//   marker.setMap(null)
//  })

  //This removes all the markers off the page
  $(document).on("ajax:success", '#remove-marker-data-id', function(e){
      marker.setMap(null)
    })
//Attempt to remove only ONE marker at a time
  // var removeLink = responseData.find('button.remove-marker')[0];
  // google.maps.event.addDomListener(removeLink, 'click', function(event){
  //   marker.setMap(null)
  // })
 
});
} else {
  google.maps.event.addListener(map, 'click', function loggedOutUserClick(event){
  if (confirm('Would you like to login?') ) {
    window.location = "/login";
  } else {
    alert("You must login to add a bike incident to the map.")
  }
});
}

});
// Make an ajax get request to '/bike_events'
function fetchMarkers(map) {
  $.get('/bike_events', function(data ) {
    console.log("Hi AGAIN!");
    data.forEach(function(bikeEvent){
      var latLng = {lat: +bikeEvent.latitude, lng: +bikeEvent.longitude};
      new google.maps.Marker({
        position: latLng,
        map: map,
        draggable: false,
        animation: google.maps.Animation.DROP,
        icon: "<%= asset_path('bike_marker2.png') %>"
      });
    })
  });
}
